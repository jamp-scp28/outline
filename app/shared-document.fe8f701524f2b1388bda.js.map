{"version":3,"sources":["webpack:///./app/components/SearchListItem.tsx","webpack:///./app/components/SearchPopover.tsx","webpack:///./app/components/Sidebar/components/SharedDocumentLink.tsx","webpack:///./app/components/Sidebar/Shared.tsx","webpack:///./app/scenes/Document/Shared.tsx"],"names":["SEARCH_RESULT_REGEX","replaceResultMarks","tag","replace","DocumentListItem","props","ref","document","highlight","context","shareId","rest","CompositeItem","as","DocumentLink","dir","to","pathname","url","state","title","titleWithDefault","Content","Heading","Title","text","ResultContext","undefined","processResult","styled","div","Link","breakpoint","hover","theme","listItemHoverBackground","$menuOpen","css","h4","rtl","Highlight","Mark","textTertiary","observer","React","NoResults","Empty","PlaceholderList","Placeholder","StyledInputSearch","InputSearch","Outline","SearchPopover","t","useTranslation","documents","useStores","focusRef","popover","usePopoverState","placement","unstable_offset","modal","query","setQuery","searchResults","cachedQuery","setCachedQuery","cachedSearchResults","setCachedSearchResults","show","performSearch","options","length","search","handleSearchInputChange","event","value","target","trim","hide","searchInputRef","unstable_referenceRef","firstSearchItem","handleEscapeList","current","focus","handleSearchInputFocus","handleKeyDown","ev","key","shiftKey","currentTarget","selectionStart","visible","preventDefault","selectionEnd","handleSearchItemClick","getElementById","bodyContentId","useKeyDown","activeElement","PopoverDisclosure","aria-controls","aria-expanded","aria-haspopup","onChange","onFocus","onKeyDown","Popover","aria-label","unstable_autoFocusOnShow","unstable_finalFocusRef","style","zIndex","depths","sidebar","shrink","PaginatedList","snippetMinWords","snippetMaxWords","items","fetch","onEscape","empty","loading","count","header","height","renderItem","item","index","compositeProps","SearchListItem","id","onClick","node","collection","activeDocument","activeDocumentId","isDraft","depth","isActiveDocument","hasChildDocuments","children","parentDocumentId","get","showChildren","expanded","setExpanded","handleDisclosureClick","stopPropagation","nodeChildren","isActive","asNavigationNode","SidebarLink","label","Disclosure","exact","scrollIntoViewIfNeeded","isStarred","map","childNode","ObservedDocumentLink","parentId","ScrollContainer","Scrollable","TopSection","Section","SharedSidebar","rootNode","ui","Sidebar","flex","active","EMPTY_OBJECT","useDocumentId","documentSlug","response","documentId","sharedTree","findInTree","endsWith","SharedDocumentScene","useTheme","setResponse","error","setError","match","params","window","body","background","setActiveDocument","fetchWithSharedTree","fetchData","OfflineError","ErrorOffline","Error404","Loading","location","Layout","Document","abilities","readOnly"],"mappings":"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","file":"shared-document.fe8f701524f2b1388bda.js","sourcesContent":["import { observer } from \"mobx-react\";\nimport * as React from \"react\";\nimport { Link } from \"react-router-dom\";\nimport { CompositeItem } from \"reakit/Composite\";\nimport styled, { css } from \"styled-components\";\nimport breakpoint from \"styled-components-breakpoint\";\nimport Document from \"~/models/Document\";\nimport Highlight, { Mark } from \"~/components/Highlight\";\nimport { hover } from \"~/styles\";\n\ntype Props = {\n  document: Document;\n  highlight: string;\n  context: string | undefined;\n  showParentDocuments?: boolean;\n  showCollection?: boolean;\n  showPublished?: boolean;\n  shareId?: string;\n  onClick?: React.MouseEventHandler<HTMLAnchorElement>;\n};\nconst SEARCH_RESULT_REGEX = /<b\\b[^>]*>(.*?)<\\/b>/gi;\n\nfunction replaceResultMarks(tag: string) {\n  // don't use SEARCH_RESULT_REGEX here as it causes\n  // an infinite loop to trigger a regex inside it's own callback\n  return tag.replace(/<b\\b[^>]*>(.*?)<\\/b>/gi, \"$1\");\n}\n\nfunction DocumentListItem(\n  props: Props,\n  ref: React.RefObject<HTMLAnchorElement>\n) {\n  const { document, highlight, context, shareId, ...rest } = props;\n\n  return (\n    <CompositeItem\n      as={DocumentLink}\n      ref={ref}\n      dir={document.dir}\n      to={{\n        pathname: shareId ? `/share/${shareId}${document.url}` : document.url,\n        state: {\n          title: document.titleWithDefault,\n        },\n      }}\n      {...rest}\n    >\n      <Content>\n        <Heading dir={document.dir}>\n          <Title\n            text={document.titleWithDefault}\n            highlight={highlight}\n            dir={document.dir}\n          />\n        </Heading>\n\n        {\n          <ResultContext\n            text={context}\n            highlight={highlight ? SEARCH_RESULT_REGEX : undefined}\n            processResult={replaceResultMarks}\n          />\n        }\n      </Content>\n    </CompositeItem>\n  );\n}\n\nconst Content = styled.div`\n  flex-grow: 1;\n  flex-shrink: 1;\n  min-width: 0;\n`;\n\nconst DocumentLink = styled(Link)<{\n  $isStarred?: boolean;\n  $menuOpen?: boolean;\n}>`\n  display: flex;\n  align-items: center;\n  padding: 6px 12px;\n  max-height: 50vh;\n\n  &:not(:last-child) {\n    margin-bottom: 4px;\n  }\n\n  &:focus-visible {\n    outline: none;\n  }\n\n  ${breakpoint(\"tablet\")`\n    width: auto;\n  `};\n\n  &:${hover},\n  &:active,\n  &:focus,\n  &:focus-within {\n    background: ${(props) => props.theme.listItemHoverBackground};\n  }\n\n  ${(props) =>\n    props.$menuOpen &&\n    css`\n      background: ${(props) => props.theme.listItemHoverBackground};\n    `}\n`;\n\nconst Heading = styled.h4<{ rtl?: boolean }>`\n  display: flex;\n  justify-content: ${(props) => (props.rtl ? \"flex-end\" : \"flex-start\")};\n  align-items: center;\n  height: 18px;\n  margin-top: 0;\n  margin-bottom: 0.25em;\n  overflow: hidden;\n  white-space: nowrap;\n  color: ${(props) => props.theme.text};\n`;\n\nconst Title = styled(Highlight)`\n  max-width: 90%;\n  overflow: hidden;\n  text-overflow: ellipsis;\n\n  ${Mark} {\n    padding: 0;\n  }\n`;\n\nconst ResultContext = styled(Highlight)`\n  display: block;\n  color: ${(props) => props.theme.textTertiary};\n  font-size: 14px;\n  margin-top: -0.25em;\n  margin-bottom: 0.25em;\n\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n\n  ${Mark} {\n    padding: 0;\n  }\n`;\n\nexport default observer(React.forwardRef(DocumentListItem));\n","import { debounce } from \"lodash\";\nimport { observer } from \"mobx-react\";\nimport * as React from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { usePopoverState, PopoverDisclosure } from \"reakit/Popover\";\nimport styled from \"styled-components\";\nimport { depths } from \"@shared/styles\";\nimport Empty from \"~/components/Empty\";\nimport { Outline } from \"~/components/Input\";\nimport InputSearch from \"~/components/InputSearch\";\nimport Placeholder from \"~/components/List/Placeholder\";\nimport PaginatedList, { PaginatedItem } from \"~/components/PaginatedList\";\nimport Popover from \"~/components/Popover\";\nimport { id as bodyContentId } from \"~/components/SkipNavContent\";\nimport useKeyDown from \"~/hooks/useKeyDown\";\nimport useStores from \"~/hooks/useStores\";\nimport { SearchResult } from \"~/types\";\nimport SearchListItem from \"./SearchListItem\";\n\ntype Props = { shareId: string };\n\nfunction SearchPopover({ shareId }: Props) {\n  const { t } = useTranslation();\n  const { documents } = useStores();\n  const focusRef = React.useRef<HTMLElement | null>(null);\n\n  const popover = usePopoverState({\n    placement: \"bottom-start\",\n    unstable_offset: [-24, 0],\n    modal: true,\n  });\n\n  const [query, setQuery] = React.useState(\"\");\n  const searchResults = documents.searchResults(query);\n\n  const [cachedQuery, setCachedQuery] = React.useState(query);\n  const [cachedSearchResults, setCachedSearchResults] = React.useState<\n    PaginatedItem[] | undefined\n  >(searchResults);\n\n  React.useEffect(() => {\n    if (searchResults) {\n      setCachedQuery(query);\n      setCachedSearchResults(searchResults);\n      popover.show();\n    }\n  }, [searchResults, query, popover.show]);\n\n  const performSearch = React.useCallback(\n    async ({ query, ...options }) => {\n      if (query?.length > 0) {\n        return await documents.search(query, { shareId, ...options });\n      }\n      return undefined;\n    },\n    [documents, shareId]\n  );\n\n  const handleSearchInputChange = React.useMemo(\n    () =>\n      debounce(async (event: React.ChangeEvent<HTMLInputElement>) => {\n        const { value } = event.target;\n        setQuery(value.trim());\n\n        // covers edge case: user manually dismisses popover then\n        // quickly edits input resulting in no change in query\n        // the useEffect that normally shows the popover will miss it\n        if (value === cachedQuery) {\n          popover.show();\n        }\n\n        if (!value.length) {\n          popover.hide();\n        }\n      }, 300),\n    [popover, cachedQuery]\n  );\n\n  const searchInputRef = popover.unstable_referenceRef as React.RefObject<\n    HTMLInputElement\n  >;\n\n  const firstSearchItem = React.useRef<HTMLAnchorElement>(null);\n\n  const handleEscapeList = React.useCallback(\n    () => searchInputRef?.current?.focus(),\n    [searchInputRef]\n  );\n\n  const handleSearchInputFocus = React.useCallback(() => {\n    focusRef.current = searchInputRef.current;\n  }, []);\n\n  const handleKeyDown = React.useCallback(\n    (ev: React.KeyboardEvent<HTMLInputElement>) => {\n      if (ev.key === \"Enter\") {\n        if (searchResults) {\n          popover.show();\n        }\n      }\n\n      if (ev.key === \"ArrowDown\" && !ev.shiftKey) {\n        if (ev.currentTarget.value.length) {\n          if (\n            ev.currentTarget.value.length === ev.currentTarget.selectionStart\n          ) {\n            popover.show();\n          }\n          firstSearchItem.current?.focus();\n        }\n      }\n\n      if (ev.key === \"ArrowUp\") {\n        if (popover.visible) {\n          popover.hide();\n          if (!ev.shiftKey) {\n            ev.preventDefault();\n          }\n        }\n\n        if (ev.currentTarget.value) {\n          if (ev.currentTarget.selectionEnd === 0) {\n            ev.currentTarget.selectionStart = 0;\n            ev.currentTarget.selectionEnd = ev.currentTarget.value.length;\n            ev.preventDefault();\n          }\n        }\n      }\n\n      if (ev.key === \"Escape\") {\n        if (popover.visible) {\n          popover.hide();\n          ev.preventDefault();\n        }\n      }\n    },\n    [popover, searchResults]\n  );\n\n  const handleSearchItemClick = React.useCallback(() => {\n    popover.hide();\n    if (searchInputRef.current) {\n      searchInputRef.current.value = \"\";\n      focusRef.current = document.getElementById(bodyContentId);\n    }\n  }, [popover.hide]);\n\n  useKeyDown(\"/\", (ev) => {\n    if (\n      searchInputRef.current &&\n      searchInputRef.current !== document.activeElement\n    ) {\n      searchInputRef.current.focus();\n      ev.preventDefault();\n    }\n  });\n\n  return (\n    <>\n      <PopoverDisclosure {...popover}>\n        {(props) => {\n          // props assumes the disclosure is a button, but we want a type-ahead\n          // so we take the aria props, and ref and ignore the event handlers\n          return (\n            <StyledInputSearch\n              aria-controls={props[\"aria-controls\"]}\n              aria-expanded={props[\"aria-expanded\"]}\n              aria-haspopup={props[\"aria-haspopup\"]}\n              ref={props.ref}\n              onChange={handleSearchInputChange}\n              onFocus={handleSearchInputFocus}\n              onKeyDown={handleKeyDown}\n            />\n          );\n        }}\n      </PopoverDisclosure>\n      <Popover\n        {...popover}\n        aria-label={t(\"Results\")}\n        unstable_autoFocusOnShow={false}\n        unstable_finalFocusRef={focusRef}\n        style={{ zIndex: depths.sidebar + 1 }}\n        shrink\n      >\n        <PaginatedList\n          options={{ query, snippetMinWords: 10, snippetMaxWords: 11 }}\n          items={cachedSearchResults}\n          fetch={performSearch}\n          onEscape={handleEscapeList}\n          empty={\n            <NoResults>{t(\"No results for {{query}}\", { query })}</NoResults>\n          }\n          loading={<PlaceholderList count={3} header={{ height: 20 }} />}\n          renderItem={(item: SearchResult, index, compositeProps) => (\n            <SearchListItem\n              key={item.document.id}\n              shareId={shareId}\n              ref={index === 0 ? firstSearchItem : undefined}\n              document={item.document}\n              context={item.context}\n              highlight={cachedQuery}\n              onClick={handleSearchItemClick}\n              {...compositeProps}\n            />\n          )}\n        />\n      </Popover>\n    </>\n  );\n}\n\nconst NoResults = styled(Empty)`\n  padding: 0 12px;\n  margin: 6px 0;\n`;\n\nconst PlaceholderList = styled(Placeholder)`\n  padding: 6px 12px;\n`;\n\nconst StyledInputSearch = styled(InputSearch)`\n  ${Outline} {\n    border-radius: 16px;\n  }\n`;\n\nexport default observer(SearchPopover);\n","import { observer } from \"mobx-react\";\nimport * as React from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport Collection from \"~/models/Collection\";\nimport Document from \"~/models/Document\";\nimport useStores from \"~/hooks/useStores\";\nimport { NavigationNode } from \"~/types\";\nimport Disclosure from \"./Disclosure\";\nimport SidebarLink from \"./SidebarLink\";\n\ntype Props = {\n  node: NavigationNode;\n  collection?: Collection;\n  activeDocumentId: string | undefined;\n  activeDocument: Document | undefined;\n  isDraft?: boolean;\n  depth: number;\n  index: number;\n  shareId: string;\n  parentId?: string;\n};\n\nfunction DocumentLink(\n  {\n    node,\n    collection,\n    activeDocument,\n    activeDocumentId,\n    isDraft,\n    depth,\n    shareId,\n  }: Props,\n  ref: React.RefObject<HTMLAnchorElement>\n) {\n  const { documents } = useStores();\n  const { t } = useTranslation();\n\n  const isActiveDocument = activeDocumentId === node.id;\n\n  const hasChildDocuments =\n    !!node.children.length || activeDocument?.parentDocumentId === node.id;\n  const document = documents.get(node.id);\n\n  const showChildren = React.useMemo(() => {\n    return !!hasChildDocuments;\n  }, [hasChildDocuments]);\n\n  const [expanded, setExpanded] = React.useState(showChildren);\n\n  React.useEffect(() => {\n    if (showChildren) {\n      setExpanded(showChildren);\n    }\n  }, [showChildren]);\n\n  const handleDisclosureClick = React.useCallback(\n    (ev: React.SyntheticEvent) => {\n      ev.preventDefault();\n      ev.stopPropagation();\n      setExpanded(!expanded);\n    },\n    [expanded]\n  );\n\n  // since we don't have access to the collection sort here, we just put any\n  // drafts at the front of the list. this is slightly inconsistent with the\n  // logged-in behavior, but it's probably better to emphasize the draft state\n  // of the document in a shared context\n  const nodeChildren = React.useMemo(() => {\n    if (\n      activeDocument?.isDraft &&\n      activeDocument?.isActive &&\n      activeDocument?.parentDocumentId === node.id\n    ) {\n      return [activeDocument?.asNavigationNode, ...node.children];\n    }\n\n    return node.children;\n  }, [\n    activeDocument?.isActive,\n    activeDocument?.isDraft,\n    activeDocument?.parentDocumentId,\n    activeDocument?.asNavigationNode,\n    node,\n  ]);\n\n  const title =\n    (activeDocument?.id === node.id ? activeDocument.title : node.title) ||\n    t(\"Untitled\");\n\n  return (\n    <>\n      <SidebarLink\n        to={{\n          pathname: `/share/${shareId}${node.url}`,\n          state: {\n            title: node.title,\n          },\n        }}\n        label={\n          <>\n            {hasChildDocuments && (\n              <Disclosure expanded={expanded} onClick={handleDisclosureClick} />\n            )}\n            {title}\n          </>\n        }\n        depth={depth}\n        exact={false}\n        scrollIntoViewIfNeeded={!document?.isStarred}\n        isDraft={isDraft}\n        ref={ref}\n        isActive={() => {\n          return !!isActiveDocument;\n        }}\n      />\n      {expanded &&\n        nodeChildren.map((childNode, index) => (\n          <ObservedDocumentLink\n            shareId={shareId}\n            key={childNode.id}\n            collection={collection}\n            node={childNode}\n            activeDocumentId={activeDocumentId}\n            activeDocument={activeDocument}\n            isDraft={childNode.isDraft}\n            depth={depth + 1}\n            index={index}\n            parentId={node.id}\n          />\n        ))}\n    </>\n  );\n}\n\nconst ObservedDocumentLink = observer(React.forwardRef(DocumentLink));\n\nexport default ObservedDocumentLink;\n","import { observer } from \"mobx-react\";\nimport * as React from \"react\";\nimport styled from \"styled-components\";\nimport Scrollable from \"~/components/Scrollable\";\nimport SearchPopover from \"~/components/SearchPopover\";\nimport useStores from \"~/hooks/useStores\";\nimport { NavigationNode } from \"~/types\";\nimport Sidebar from \"./Sidebar\";\nimport Section from \"./components/Section\";\nimport DocumentLink from \"./components/SharedDocumentLink\";\n\ntype Props = {\n  rootNode: NavigationNode;\n  shareId: string;\n};\n\nfunction SharedSidebar({ rootNode, shareId }: Props) {\n  const { ui, documents } = useStores();\n\n  return (\n    <Sidebar>\n      <ScrollContainer flex>\n        <TopSection>\n          <SearchPopover shareId={shareId} />\n        </TopSection>\n        <Section>\n          <DocumentLink\n            index={0}\n            shareId={shareId}\n            depth={1}\n            node={rootNode}\n            activeDocumentId={ui.activeDocumentId}\n            activeDocument={documents.active}\n          />\n        </Section>\n      </ScrollContainer>\n    </Sidebar>\n  );\n}\n\nconst ScrollContainer = styled(Scrollable)`\n  padding-bottom: 16px;\n`;\n\nconst TopSection = styled(Section)`\n  // this weird looking && increases the specificity of the style rule\n  && {\n    margin-top: 16px;\n    margin-bottom: 16px;\n  }\n`;\n\nexport default observer(SharedSidebar);\n","import { Location } from \"history\";\nimport { observer } from \"mobx-react\";\nimport * as React from \"react\";\nimport { RouteComponentProps } from \"react-router-dom\";\nimport { useTheme } from \"styled-components\";\nimport DocumentModel from \"~/models/Document\";\nimport Error404 from \"~/scenes/Error404\";\nimport ErrorOffline from \"~/scenes/ErrorOffline\";\nimport Layout from \"~/components/Layout\";\nimport Sidebar from \"~/components/Sidebar/Shared\";\nimport useStores from \"~/hooks/useStores\";\nimport { NavigationNode } from \"~/types\";\nimport { OfflineError } from \"~/utils/errors\";\nimport Document from \"./components/Document\";\nimport Loading from \"./components/Loading\";\n\nconst EMPTY_OBJECT = {};\n\ntype Response = {\n  document: DocumentModel;\n  sharedTree?: NavigationNode | undefined;\n};\n\ntype Props = RouteComponentProps<{\n  shareId: string;\n  documentSlug: string;\n}> & {\n  location: Location<{ title?: string }>;\n};\n\n/**\n * Find the document UUID from the slug given the sharedTree\n *\n * @param documentSlug The slug from the url\n * @param response The response payload from the server\n * @returns The document UUID, if found.\n */\nfunction useDocumentId(documentSlug: string, response?: Response) {\n  let documentId;\n\n  function findInTree(node: NavigationNode) {\n    if (node.url.endsWith(documentSlug)) {\n      documentId = node.id;\n      return true;\n    }\n    if (node.children) {\n      for (const child of node.children) {\n        if (findInTree(child)) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\n  if (response?.sharedTree) {\n    findInTree(response.sharedTree);\n  }\n\n  return documentId;\n}\n\nfunction SharedDocumentScene(props: Props) {\n  const { ui } = useStores();\n  const theme = useTheme();\n  const [response, setResponse] = React.useState<Response>();\n  const [error, setError] = React.useState<Error | null | undefined>();\n  const { documents } = useStores();\n  const { shareId, documentSlug } = props.match.params;\n  const documentId = useDocumentId(documentSlug, response);\n\n  // ensure the wider page color always matches the theme\n  React.useEffect(() => {\n    window.document.body.style.background = theme.background;\n  }, [theme]);\n\n  React.useEffect(() => {\n    if (documentId) {\n      ui.setActiveDocument(documentId);\n    }\n  }, [ui, documentId]);\n\n  React.useEffect(() => {\n    async function fetchData() {\n      try {\n        const response = await documents.fetchWithSharedTree(documentSlug, {\n          shareId,\n        });\n        setResponse(response);\n      } catch (err) {\n        setError(err);\n      }\n    }\n    fetchData();\n  }, [documents, documentSlug, shareId, ui]);\n\n  if (error) {\n    return error instanceof OfflineError ? <ErrorOffline /> : <Error404 />;\n  }\n\n  if (!response) {\n    return <Loading location={props.location} />;\n  }\n\n  const sidebar = response.sharedTree ? (\n    <Sidebar rootNode={response.sharedTree} shareId={shareId} />\n  ) : undefined;\n\n  return (\n    <Layout title={response.document.title} sidebar={sidebar}>\n      <Document\n        abilities={EMPTY_OBJECT}\n        document={response.document}\n        sharedTree={response.sharedTree}\n        shareId={shareId}\n        readOnly\n      />\n    </Layout>\n  );\n}\n\nexport default observer(SharedDocumentScene);\n"],"sourceRoot":""}